<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>{{ site_name }}</title>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.6/mapbox.css' rel='stylesheet' />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link href='css/ndt_d3.css' rel='stylesheet' />
  <link href="css/jquery-ui-slider-pips.css" rel="stylesheet" />
  <link href='css/jquery-ui.min.css' rel='stylesheet' />
  <link href='css/mlab.css' rel='stylesheet' />
  <script src='//api.tiles.mapbox.com/mapbox.js/v2.1.6/mapbox.js'></script>
  <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src='js/mlab.js'></script>
  <script src='js/ndt.js'></script>
  <script src='js/ndt_d3.js'></script>
  <script src='js/d3.v3.min.js'></script>
  <script src='js/center.js'></script>
  <script src="js/jquery-ui.min.js"></script>
  <script src="js/jquery-ui-slider-pips.min.js"></script>
</head>

<body>

<div id="spinner">
  <div id="spin">&nbsp;</div>
  <div id="loading">LOADING</div>
</div>

<div id="welcome-container">
  <div id="header">
    <div id="intro">
      <h3>{{ intro_text }}</h3>
      <p>{{ instructions_text }}</p>
    </div>
  </div>
  <div id="faq">
    <details>
  <summary>How will my data be shared?</summary>
  <p>The Measurement Lab (M-Lab) platform is run by the scientific community. We make all test results publicly available via the MeasurementLab.net website to help promote Internet research. M-Lab's Network Diagnostic Tool collects a number of measures of different facets of your Internet connection. The information published includes each deviceâ€™s IP address, but does not include personal identifying information about you as an Internet user.</p>
</details>
<details>
  <summary>How will my information be secured?</summary>
  <p>The Quello Center and Merit Network will be responsible for data management related to this project. Data will be maintained and archived in a secure and password-protected repository at servers at Michigan State University. Data and metadata will be provided in accordance with the Data Documentation Initiative (DDI) standard for the social, behavioral, and economic sciences. All data will be made available in a format that protects anonymity and confidentiality. </p>
</details>
<details>
  <summary>What is the Michigan Broadband Speed Test?</summary>
  <p><strong>NEED CONTENT</strong></p>
</details>
<details>
  <summary>How does the Broadband Speed Test work?</summary>
  <p>The Michigan Broadband Speed Test utilizes the open source test and servers provided by Measurement Lab (M-Lab), a consortium of public interest groups, academic institutions and industry partners, providing an open platform dedicated to Internet performance measurement. When you start a test, your browser opens a connection to the closest M-Lab server. It then exchanges with the server a synthetic stream of data, generated solely for the purpose of measuring your connection at that time. During the test, the server collects around 100 low-level metrics. When the test is completed, the user is shown three of the most accessible measurements: download speed, upload speed, and minimum round trip time.</p>
</details>
<details>
  <summary>Why does this test show different results than other tests like speedtest.net?</summary>
  <p>Different network measurement tests sometimes show variance in results due to factors such as the methodology of the test. Both <a href="https://speedtest.net">speedtest.net</a> and M-Lab's tests are valid measurements but have different methods and instrumentation which account for the difference in measurements.</p>

  <p>In both M-Lab's NDT test and Ookla's <a href="https://speedtest.net">speedtest.net</a> test, there is a client and a server component. The client is the test running in your browser in both cases. Ookla's servers are always within the ISP's last mile network, while M-Lab's servers are always in transit data centers, outside of any ISP last mile network. The FCC (and their measurement consultant SamKnows) refer to this difference as "on-net" and "off-net" measurement. You can learn more about this difference at this link: <a href="http://samknows.com/infrastructure">http://samknows.com/infrastructure.</a></p>

<p>The <a href="https://speedtest.net">speedtest.net</a> test is an on-net measurement of your connection's performance to the edge of your ISP's network, and M-Lab's test is an off-net measurement of your connection's performance through your ISP's network to one of M-Lab's servers in a Seattle Internet exchange point. M-Lab's methodology is based on the rationale that consumers request content from the Internet which could be anywhere in the world, most of which is outside their ISP's network. By tracing the performance over the full path of the your broadband connection to the global Internet, M-Lab measures the performance of your connection across interconnected networks, which is closer to the way you access the Internet everyday.</p>
</details>
<details>
  <summary>What data does this test collect, and how will it be used?</summary>
  <p>Before you take the test, you will be asked for your location and some basic information about your connection. You can also share what speeds are advertised under your current contract. This data will be stored in a private database, combined with other results, and published to the map and to data.seattle.gov in anonymized form.</p>

<p>This test does not collect information about your other Internet traffic, such as your emails, web searches, etc., or any personally identifiable information. The data it sends across your network is synthetic - meaning it does not come from your device or other applications you are operating - and will be used for measurement only. The speed test data is submitted to M-Lab in aggregated form to assure that the anonymity of users is protected.</p>
</details>
<details>
  <summary>What do these results mean?</summary>
  <p>Your speed test results show the actual upload and download speeds you are experiencing at the time you take the test. Results can vary due to the device you are using, your operating system, the browser you use, the time of day you take the test, whether you are using WiFi or a wired connection, the number of devices connected to the same signal at once, and many other factors. You can take this test as many times as you like, from as many devices and locations as you like. If the speeds you are receiving do not match up to your expectations, you have a number of options.</p>
</details>
<details>
  <summary>What can I do if I want faster internet?</summary>
  <p>To improve your speed, you can:
    <ul>
      <li><strong>Assess your usage.</strong> By reducing the number of devices connected to your network at the same time, shifting your peak usage away from peak hours (e.g. downloading large files after midnight), and closing programs that run in the background (common examples include Dropbox and desktop clients), you can improve performance on a single device.
      </li>
      <li><strong>Check your equipment.</strong> By switching from a wireless to a wired connection, resetting your router, or updating your WiFi router or network card, you may be able to improve performance significantly.</li>
      <li><strong>Upgrade your plan, or switch providers.</strong> Many households have an option of two and in some cases three Internet Service Providers. Using data submitted for this test, consumers may be able to see which providers are available in their area.</li>
  </ul>
</p>
</details>
<details>
  <summary>What can I do if I believe my Internet Service Provider is not delivering the speeds it promises?</summary>
  <p>First, we suggest you take the steps above to ensure that your test results are a more accurate measurement of the capacity that is being delivered to your home. Then, contact your Internet Service Provider (ISP) directly and ask them to resolve any issues. If you believe your ISP is violating federal Open Internet rules, you can file a complaint with the Federal Communications Commission (FCC). The FCC is the only body that is authorized to regulate and oversee Internet Service Providers. You can find more information about the FCC's Open Internet rules, and the complaint form, <a href="https://consumercomplaints.fcc.gov/hc/en-us/articles/204231404-Open-Internet">here.</a></p>
</details>
<details>
  <summary>How can I learn more?</summary>
  <p><strong>NEED CONTENT</strong></p>
</details>
  </div>
  <div id="sidebar">
    <form action="/collector/collect" method="get" id="collector">
      <div id="extra-data" class="ndt-related">
        <div class="container" id="all-form-fields">
          {% for item, field in form_fields.items() -%}
            {% for attr, vals in field.items() -%}
          <div class="form-field" id="container-{{ vals['id'] }}">
            <div class="field-container">
              {{ vals['text'] }}
            </div>
            <div class="field-container">
            {% if vals['field_type'] == 'select_list' -%}
              <select id="{{ vals['id'] }}" name="{{ vals['name'] }}" class="form-control">
              {% for opt, item in vals.options.items() | sort -%}
                <option value="{{ opt }}"{%- if opt == 'default' %} selected {%- endif -%}>{{ item }}</option>
              {%- endfor -%}
              </select>
            {% elif vals['field_type'] == 'text' -%}
              <input id="{{ vals['id'] }}" type="text" name="{{ vals['name'] }}" class="form-control"{%- if vals['size'] is defined %} size="{{ vals['size'] }}"{%- endif -%}/>
            {% endif -%}
            </div>
          </div>
            {% endfor -%}
          {% endfor -%}
        </div>
        <div class="container" id="consent-text">
        <p>
          <span class="required">*</span> <input type="checkbox" name="data_acknowledgement" id="data_acknowledgement" value="yes" /> {{ consent_message }}
        </p>
        </div>
        <input name="latitude" id="latitude" type="hidden" />
        <input name="longitude" id="longitude" type="hidden" />
        <input name="actual_download" id="actual_download" type="hidden" />
        <input name="actual_upload" id="actual_upload" type="hidden" />
        <input name="min_rtt" id="min_rtt" type="hidden" />
        <input name="bigquery_key" id="bigquery_key" type="hidden" />
      </div>
      <div id="test-container">
        <div id="ndt-div">
          <div id="ndt-svg"></div>
        </div>
	    <div id="approx-loc">
	      <h3 class="league-gothic">{{ run_test_heading }}</h3>
	      <div id="ndt-status"></div>
	    </div>
	    <div id="ndt-results" class="ndt-related">
	      <div class="container">
	        <div id="your-results">
	          <h3 class="league-gothic">{{ test_result_heading }}</h3>
	          <p>{{ download_result_label }} <span id="s2cRate"></span> {{ download_result_unit }}</p>
	          <p>{{ upload_result_label }} <span id="c2sRate"></span> {{ upload_result_unit }}</p>
	          <p>{{ rtt_result_label }} <span id="MinRTT"></span> {{ rtt_result_unit }}</p>
	        </div>
	        <div id="thankyou">
	          <h3 class="league-gothic">{{ thank_you_heading }}</h3>
	          <strong>{{ thank_you_message }}</strong><br /><br />
	          <strong>{{ next_action_message }}</strong>
	          <ul>
	            <li><a href="#" onclick="showMap()">{{ next_action_show_map_text }}</a></li>
	            <li><a href="{{ next_action_learn_about_link }}" target="_parent">{{ next_action_learn_about_text }}</a></li>
	            <li><a href="#" onclick="showSocialShare()">{{ next_action_social_share_text }}</a></li>
	          </ul>
	          <div id="socialshare">
	          <!-- Social Button HTML -->
	          {% if social_share_twitter is not none -%}
	          <!-- Twitter -->
	            <a href="{{ social_share_twitter }}"" target="_blank" class="share-btn twitter">
	            <i class="fa fa-twitter"></i>
	            </a>
	          {% endif %}
	          {%- if social_share_gplus is not none -%}
	          <!-- Google Plus -->
	            <a href="{{ social_share_gplus }}" target="_blank" class="share-btn google-plus">
	            <i class="fa fa-google-plus"></i>
	            </a>
	          {% endif %}
	          {%- if social_share_facebook is not none -%}
	          <!-- Facebook -->
	            <a href="{{ social_share_facebook }}" target="_blank" class="share-btn facebook">
	            <i class="fa fa-facebook"></i>
	            </a>
	          {% endif %}
	          {%- if social_share_stumbleupon is not none -%}
	          <!-- StumbleUpon (url, title) -->
	            <a href="{{ social_share_stumbleupon }}" target="_blank" class="share-btn stumbleupon">
	            <i class="fa fa-stumbleupon"></i>
	            </a>
	          {% endif %}
	          {%- if social_share_reddit is not none -%}
	          <!-- Reddit (url, title) -->
	            <a href="{{ social_share_reddit }}" target="_blank" class="share-btn reddit">
	            <i class="fa fa-reddit"></i>
	            </a>
	          {% endif %}
	          {%- if social_share_linkedin is not none -%}
	          <!-- LinkedIn -->
	            <a href="{{ social_share_linkedin }}" target="_blank" class="share-btn linkedin">
	            <i class="fa fa-linkedin"></i>
	            </a>
	          {% endif %}
	          {%- if social_share_email is not none -%}
	          <!-- Email -->
	            <a href="{{ social_share_email }}" target="_blank" class="share-btn email">
	            <i class="fa fa-envelope"></i>
	            </a>
	          {% endif -%}
	          </div>
	        </div> <!-- thankyou div -->
	      </div>
	    </div>
	  </div>
    </form>
    <div id="icons">
      <div id="take-test" onclick="runTest()">
        <img src="images/speed.svg" id="test-icon" alt="{{ icon_test_label }}" title="{{ icon_test_label }}" /><span class="button-label">{{ icon_test_label }}</span>
      </div>
      <div id="explore-map" onclick="showMap()">
        <img src="images/compass.png" id="exploreMap" alt="{{ icon_browse_label }}" title="{{ icon_browse_label }}" /><span class="button-label">{{ icon_browse_label }}</span>
      </div>
      <div id="learn-more">
        <a href="{{ icon_learn_link }}" target="_parent" ><img src="images/about.svg" alt="{{ icon_learn_alt_text }}" title="{{ icon_learn_alt_text }}" /><span class="button-label">{{ icon_learn_label }}</span></a>
      </div>
    </div>
  </div>
</div>
<script>
var ndtServer,
	ndtServerIp,
	ndtPort = "3010",
	ndtProtocol = 'wss',
	ndtPath = "/ndt_protocol",
	ndtUpdateInterval = 1000,
	c2sRate,
	s2cRate,
	MinRTT;

getNdtServer();

uncheckAcknowledgement();

NDT_meter = new NDTmeter('#ndt-svg');
NDT_meter.meter.on("click", function () {
	NDT_client = new NDTjs(ndtServer, ndtPort, ndtProtocol, ndtPath, NDT_meter, ndtUpdateInterval);
	NDT_client.startTest();
});

if ("geolocation" in navigator) {
	navigator.geolocation.getCurrentPosition(success, error);
}

function success(position) {

	document.getElementById('latitude').value = position.coords.latitude;
	document.getElementById('longitude').value = position.coords.longitude;

	var xhr = new XMLHttpRequest(),
	currentLocationURL = "https://nominatim.openstreetmap.org/reverse?format=json&lat=" + position.coords.latitude + "&lon=" + position.coords.longitude + "&zoom=18&addressdetails=1";

	var currentLoc;
	xhr.open('GET', currentLocationURL, true);
	xhr.send();
	xhr.onreadystatechange = function () {
		if (xhr.readyState === 4) {
			if (xhr.status === 200) {
				currentLoc = JSON.parse(xhr.responseText);
				console.log("Location received");

				// currentLocText.text(currentLoc.address.road + currentLoc.address.neighbourhood + currentLoc.address.suburb + currentLoc.address.city + currentLoc.address.state);
				$('#mobile-container').append('<div id="mobile-approx-loc"></div>')
				$('#approx-loc, #mobile-approx-loc').append("<p>Searching from:</p><p>" + currentLoc.address.road + ", " + currentLoc.address.city + ", " + currentLoc.address.state + "</p>");
			} else {
				console.log('Location lookup failed');
			}
		}
	};
}

function error(error) {
	document.getElementById('msg').innerHTML = 'ERROR(' + error.code + '): ' + error.message;
}

function getNdtServer () {
	var xhr = new XMLHttpRequest(),
		mlabNsUrl = 'https://mlab-ns.appspot.com/ndt_ssl?format=json';

	xhr.open('GET', mlabNsUrl, true);
	xhr.send();
	xhr.onreadystatechange = function () {
		if (xhr.readyState === 4) {
			if (xhr.status === 200) {
				ndtServer = JSON.parse(xhr.responseText).fqdn;
				ndtServerIp = JSON.parse(xhr.responseText).ip;
				console.log('Using M-Lab Server ' + ndtServer);
			} else {
				console.log('M-Lab NS lookup failed.');
			}
		}
	};
};
</script>

<div id="map">
  <div id="mapview-icons">
  <a href="index.html" alt="{{ mapview_icon_test_alt_text }}" title="{{ mapview_icon_test_alt_text }}"><img src="images/speed.svg" id="mapview-test-icon" alt="{{ mapview_icon_test_alt_text }}" title="{{ mapview_icon_test_alt_text }}" /></a>
  <a href="{{ mapview_icon_learn_link }}" target="_parent" ><img src="images/about.svg" alt="{{ mapview_icon_learn_alt_text }}" title="{{ mapview_icon_learn_alt_text }}" /></a>
</div>

<script>
  // This is the Piecewise mapping script.

  // If set to 'hex' then GeoJSON files are assumed to be named like
  // 'YYYY_MM-<resolution>.json', where 3 files exist for each of resolutions
  // 'low', 'medium', 'high'.  If anything other than 'hex', then this value is
  // the MMMM_YY- suffix to look for. For example:
  // If set to 'city_council_districts', then the system will look for
  // GeoJSON files like 'MMMM_YY-city_council_districts.geojson'.

  // polygonType is a variable name defining your aggregation regions.
  // Change the name to reflect the aggregated regions you are using if needed.
  var polygonType = '{{ mapscript_layer_name }}';

  // Either 'topojson' or 'geojson'.  The Node.js script creates both TopoJSON and
  // GeoJSON files.  TopoJSON files are significantly smaller in size, but need to
  // be converted to GeoJSON by the browser.  There may be some balance between
  // loading a smaller file across the network and the processing time on the
  // client-side to convert the TopJSON to GeoJSON.  I would conjecture that
  // the network is the most limiting factor and that generally TopoJSON will be
  // the right choice.  TODO: prove this theory.
  var jsonType = '{{ mapscript_json_type }}';

  // The minimum number of data points in any given polygon for a it to be
  // considered statistically relevant.  These cells will either not be displayed
  // or will be displayed with a different styling.
  var minDataPoints = '{{ mapscript_min_data_points }}';

  // Defines how each overlay is treated on load.  If an overlay is enabled, then
  // there will be a checkbox for it in the layers control. 'defaultOn' determines
  // whether it will be displayed by default. NOTE: If only a single overlay is
  // enabled, then no checkbox will be displayed, since it doesn't make much sense
  // to disable the only meaningful layer that exists.
  var overlays = {
    'polygon': {
  	  'enabled': true,
  	  'defaultOn': true
    },
    'plot': {
      'enabled': false,
      'defaultOn': false
    }
  };

  // Defines the layers that are going to be added to the map.
  var geoLayers = {
    '{{ mapscript_layer_name }}': {
      'name': '{{ mapscript_layer_name_pretty }}',
      'polygonFile': 'geofiles/{{ topojson_file }}',
      'dataUrl': 'stats/q/{{ aggregation_name }}?format=json&stats=AverageRTT,DownloadCount,MedianDownload,AverageDownload,UploadCount,MedianUpload,AverageUpload,DownloadMax,UploadMax&b.spatial_join=key&b.time_slices=year&f.time_slices=',
      'dbKey': '{{ dbKey }}',
      'geoKey': '{{ geoKey }}',
      'cache': null,
      'layer': null
    },
  };

  // Which of the geoLayers should be the one added to the map by default
  var defaultLayer = '{{ mapscript_layer_name }}';

  // If set to true, then prefetch the GeoJSON files into a local cache.  WARNING:
  // You may not want to enable if you expect mobile, low bandwidth, or otherwise
  // bandwidth restricted users, as this can pull in many megabytes of data.
  var seedCache = false;

  // The inteval (in milliseconds) to use when animating the map.
  var animateInterval = 1500;

  var zoom = {{ mapscript_zoom_level }};

  // These are the labels that will be used for the month slider in the control
  // box in the lower left corner.
  //

  var monthNames = [
    {%- for key, value in mapscript_month_names.items() -%}
      '{{ value }}' {%- if not loop.last %}, {% endif -%}
    {%- endfor -%}
  ];

  // An object which will hold cached GeoJSON files so that we don't have to fetch
  // them from the server more than once.  This could potentially be problematic
  // if there are many files and they are large.
  var geoJsonCache = {};
  var geometryCache = null;

  // The oldest year and month for which we have data.
  var startYear = {{ mapscript_start_year }};
  var startMonth = {{ mapscript_start_month }};

  // Get current year/month into variables
  var currentYear = new Date().getFullYear();
  var currentMonth = new Date().getMonth() + 1;
  // Zero pad the front of the month
  currentMonth = currentMonth < 10 ? '0' + currentMonth : currentMonth;

  // Be sure that we actually have data for the current month.  If not, then fall
  // back to the previous month.
  var start = Date.UTC(currentYear) / 1000;
  var end = Math.floor(Date.UTC(currentYear) / 1000);
  var dataUrl = geoLayers[defaultLayer]['dataUrl'] + start + ',' + end;
  $.ajax({
  	url: dataUrl,
  	dataType: 'json',
  	async: false,
    success: function(resp) {
  	  if ( ! resp.features.length ) {
  	    if ( currentMonth == '01' ) {
  	      currentMonth = 12;
  	      currentYear = currentYear - 1;
  	    } else {
  	      currentMonth = currentMonth - 1;
  	      currentMonth = currentMonth < 10 ? '0' + currentMonth : currentMonth;
  	    }
  	    console.log("No data for current year/month, using last month instead.");
  	  }
    }
  });

  // An object with the years and months we have data for.  This will be used to
  // auto-generate various form controls.
  var dates = {};
  var thisYear = startYear;
  while (thisYear <= currentYear) {
    if (thisYear == currentYear) {
      var months = [];
      for (i = 1; i <= currentMonth; i++) { months.push(i) };
        dates[thisYear] = months
    } else {
      dates[thisYear] = ['1','2','3','4','5','6','7','8','9','10','11','12'];
    }
    thisYear++;
  }

// Create the map
var map = L.map('map', {zoomControl: false}).setView(center, zoom);
map.scrollWheelZoom.disable();
var control = L.control.zoom({position: '{{ mapcontrols_zoom_pos }}'});
map.addControl(control);

// Set the base tile layer type
{% if 'mapbox' in mapscript_base_layer %}
  // Use Mapbox as a base tile layer
  var baseTileLayer = L.tileLayer(
    '{{ mapscript_mapbox_api_url }}', {
  	  attribution: '&copy; <a href="http://mapbox.com/">Mapbox</a>'
    }
  );
{% elif 'osm' in mapscript_base_layer %}
// Use Open Street Maps as a base tile layer
  var baseTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
  });
{% endif %}

// Set the default base tile layer.
map.addLayer(baseTileLayer);

// Add other base tile layer providers as needed
var baseLayers = {
  '{{ mapscript_base_layer }}': baseTileLayer
};

var layerCtrl = L.control.layers(baseLayers, null, { collapsed: false, position: '{{ mapcontrols_legend_pos }}' });
addControls();
layerCtrl.addTo(map);
addLegend();

for (var geoLayer in geoLayers) {
  setupLayer(geoLayer);
}
</script>

</body>
</html>
